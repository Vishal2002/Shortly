// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatar    String?
  
  // YouTube OAuth
  youtubeChannelId    String?
  youtubeRefreshToken String?
  youtubeAccessToken  String?
  
  // Subscription
  plan              String    @default("free")
  videosProcessed   Int       @default(0)
  videosLimit       Int       @default(10)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  videos Video[]
  jobs   Job[]
  
  @@index([email])
}

model Job {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  youtubeUrl    String
  videoId       String?
  video         Video?   @relation(fields: [videoId], references: [id])
  
  status        String
  progress      Int      @default(0)
  currentStep   String?
  errorMessage  String?
  
  options       Json
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?
  
  @@index([userId])
  @@index([status])
}

model Video {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  youtubeId     String   @unique
  youtubeUrl    String
  title         String
  description   String?  @db.Text
  thumbnailUrl  String?
  
  duration      Int
  s3Key         String
  status        String   @default("downloaded")
  
  metadata      Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  jobs          Job[]
  segments      Segment[]
  clips         Clip[]
  
  @@index([userId])
  @@index([youtubeId])
}

model Segment {
  id              String   @id @default(uuid())
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  startTime       Int
  endTime         Int
  duration        Int
  
  compositeScore  Float
  ytRetention     Float?
  
  signals         Json
  reason          String?
  status          String   @default("detected")
  
  createdAt       DateTime @default(now())
  
  clips           Clip[]
  
  @@index([videoId])
}

model Clip {
  id              String   @id @default(uuid())
  segmentId       String
  segment         Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  s3Key           String
  thumbnailKey    String?
  
  title           String
  description     String   @db.Text
  tags            String[]
  
  predictedViews  Int?
  
  youtubeId       String?  @unique
  youtubeUrl      String?
  
  views           Int      @default(0)
  likes           Int      @default(0)
  comments        Int      @default(0)
  
  status          String   @default("ready_for_review")
  
  uploadedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([segmentId])
  @@index([videoId])
}


